<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Form Pendaftaran Layanan Internet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f3f4f6;
      margin: 0;
      padding: 16px;
    }

    .card {
      max-width: 600px;
      margin: 0 auto;
      background: #ffffff;
      border-radius: 24px;
      padding: 24px 20px 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
    }

    h1 {
      font-size: 22px;
      text-align: center;
      margin: 0 0 4px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      font-size: 13px;
      color: #6b7280;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 14px;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #111827;
    }

    input[type="text"],
    select,
    input[type="file"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      box-sizing: border-box;
    }

    input[type="text"]::placeholder {
      color: #9ca3af;
    }

    .row {
      display: flex;
      gap: 8px;
    }

    .row .form-group {
      flex: 1;
    }

    .btn-submit {
      width: 100%;
      margin-top: 10px;
      padding: 12px;
      font-size: 15px;
      font-weight: 600;
      border-radius: 999px;
      border: none;
      background: #16a34a;
      color: #ffffff;
      cursor: pointer;
    }

    .btn-submit:disabled {
      background: #9ca3af;
      cursor: not-allowed;
    }

    .info-text-sub {
      margin-top: 8px;
      font-size: 12px;
      color: #6b7280;
      text-align: center;
      line-height: 1.4;
    }

    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-list {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-top: none;
      max-height: 180px;
      overflow-y: auto;
      z-index: 50;
      border-radius: 0 0 10px 10px;
    }

    .autocomplete-item {
      padding: 8px 10px;
      font-size: 14px;
      cursor: pointer;
    }

    .autocomplete-item:hover {
      background: #f3f4f6;
    }

    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 2px;
    }

    .status-box {
      margin-top: 10px;
      font-size: 13px;
      border-radius: 12px;
      padding: 10px 12px;
      border: 1px solid transparent;
      display: none;
    }

    .status-success {
      background: #d1fae5;
      border-color: #6ee7b7;
      color: #065f46;
      white-space: pre-line;
    }

    .status-error {
      background: #fee2e2;
      border-color: #fecaca;
      color: #991b1b;
    }

    .terms-title {
      margin-top: 18px;
      font-size: 13px;
      font-weight: 700;
      color: #111827;
    }

    .terms-list {
      margin: 6px 0 0;
      padding-left: 18px;
      font-size: 12px;
      color: #4b5563;
      line-height: 1.5;
    }

    .terms-list li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>

<div class="card">
  <h1>Form Pendaftaran Layanan Internet</h1>
  <div class="subtitle">
    Data akan dikirim ke petugas resmi PT. Jaringan Teknologi Sejahtera
  </div>

  <form id="formPelanggan">
    <div class="form-group">
      <label for="nik">NIK</label>
      <input type="text" id="nik" name="nik" maxlength="16" placeholder="Masukkan NIK 16 digit" required />
      <div class="hint">Isi sesuai KTP (16 digit angka).</div>
    </div>

    <div class="form-group">
      <label for="nama">Nama Lengkap</label>
      <input type="text" id="nama" name="nama" placeholder="Nama sesuai KTP" required />
    </div>

    <div class="form-group">
      <label for="wa">Nomor WhatsApp Calon Pelanggan</label>
      <input type="text" id="wa" name="wa" placeholder="08xxxxxxxxxx" required />
    </div>

    <div class="form-group">
      <label for="paket">Paket Berlangganan</label>
      <select id="paket" name="paket" required>
        <option value="">Pilih paket…</option>
        <option value="Basic">Basic</option>
        <option value="Clasic">Clasic</option>
        <option value="Bronze">Bronze</option>
        <option value="Silver">Silver</option>
        <option value="Gold">Gold</option>
      </select>
    </div>

    <div class="form-group autocomplete-wrapper">
      <label for="kota">Kota / Kabupaten</label>
      <input type="text" id="kota" name="kota" placeholder="Ketik nama kota/kabupaten" required />
      <div id="kotaList" class="autocomplete-list" style="display:none;"></div>
    </div>

    <div class="row">
      <div class="form-group autocomplete-wrapper">
        <label for="kecamatan">Kecamatan</label>
        <input type="text" id="kecamatan" name="kecamatan" placeholder="Ketik nama kecamatan" required />
        <div id="kecamatanList" class="autocomplete-list" style="display:none;"></div>
      </div>
      <div class="form-group autocomplete-wrapper">
        <label for="desa">Desa / Kelurahan</label>
        <input type="text" id="desa" name="desa" placeholder="Ketik nama desa/kelurahan" required />
        <div id="desaList" class="autocomplete-list" style="display:none;"></div>
      </div>
    </div>
    
    <div class="form-group">
      <label for="foto">Upload Foto KTP</label>
      <input type="file" id="foto" name="foto" accept="image/*" capture="camera" required />
      <div class="hint">Upload foto KTP. Pilih file atau jepret langsung dengan kamera.</div>
    </div>
    <button type="submit" class="btn-submit" id="btnKirim">
      Daftar Sekarang
    </button>

    <div id="statusBox" class="status-box"></div>

    <div class="terms-title">
      Catatan untuk Calon Pelanggan:
    </div>
    <ul class="terms-list">
      <li>Calon Pelanggan dimohon melampirkan KTP atau NPWP yang masih berlaku saat proses administrasi.</li>
      <li>Perangkat layanan dipinjamkan oleh Class Home dan diharapkan dijaga dengan baik selama masa berlangganan.</li>
      <li>Jika saat pemasangan membutuhkan material tambahan di luar standar instalasi, biaya material tambahan ditanggung Calon Pelanggan.</li>
      <li>Penanganan kendala dilakukan pada jam kerja, pukul 08.00–16.00 WIB pada hari kerja.</li>
      <li>Pelanggan mendapatkan fasilitas dan layanan sesuai paket berlangganan yang dipilih.</li>
    </ul>

  </form>
</div>

<script src="wilayah-lampung.js"></script>
<script>
  // Data dari wilayah-lampung.js
  const daftarKota   = (typeof daftarKotaIndonesia !== "undefined") ? daftarKotaIndonesia : [];
  const kecamatanData = (typeof kecamatanLampung !== "undefined") ? kecamatanLampung : {};
  const desaData      = (typeof desaLampung !== "undefined") ? desaLampung : {};

  const inputKota = document.getElementById("kota");
  const inputKecamatan = document.getElementById("kecamatan");
  const inputDesa = document.getElementById("desa");

  const listKota = document.getElementById("kotaList");
  const listKecamatan = document.getElementById("kecamatanList");
  const listDesa = document.getElementById("desaList");

  const form = document.getElementById("formPelanggan");
  const btnKirim = document.getElementById("btnKirim");
  const statusBox = document.getElementById("statusBox");
  
  // ** URL GOOGLE APPS SCRIPT ANDA **
  const scriptUrl = "https://script.google.com/macros/s/AKfycbwbwumzh0q1a-MysMY5A7xRYdXOyo1sLow5Tf4P7fmG-LWwSAvjb1PuHGKOKPwl2xIJMw/exec"; 
  
  // Fungsi umum autocomplete (Sama seperti sebelumnya)
  function showAutocomplete(inputElem, listElem, dataArr, onSelect) {
    const keyword = inputElem.value.toLowerCase().trim();
    listElem.innerHTML = "";

    if (!keyword) {
      listElem.style.display = "none";
      return;
    }

    const filtered = dataArr.filter(item =>
      item.toLowerCase().includes(keyword)
    );

    if (filtered.length === 0) {
      listElem.style.display = "none";
      return;
    }

    filtered.forEach(item => {
      const div = document.createElement("div");
      div.className = "autocomplete-item";
      div.textContent = item;
      div.onclick = () => {
        inputElem.value = item;
        listElem.style.display = "none";
        if (typeof onSelect === "function") onSelect(item);
      };
      listElem.appendChild(div);
    });

    listElem.style.display = "block";
  }

  // Logic Autocomplete
  inputKota.addEventListener("input", function () {
    showAutocomplete(inputKota, listKota, daftarKota, () => {
      inputKecamatan.value = "";
      inputDesa.value = "";
    });
  });

  inputKecamatan.addEventListener("input", function () {
    const selectedKota = inputKota.value.trim();
    if (!selectedKota || !kecamatanData[selectedKota]) {
      listKecamatan.style.display = "none";
      return;
    }
    const listKec = kecamatanData[selectedKota];
    showAutocomplete(inputKecamatan, listKecamatan, listKec, () => {
      inputDesa.value = "";
    });
  });

  inputDesa.addEventListener("input", function () {
    const selectedKota = inputKota.value.trim();
    const selectedKec  = inputKecamatan.value.trim();

    if (!selectedKota || !selectedKec || !desaData[selectedKota]) {
      listDesa.style.display = "none";
      return;
    }

    const desaKota = desaData[selectedKota] || {};
    const daftarDesa = desaKota[selectedKec] || [];

    if (daftarDesa.length === 0) {
      listDesa.style.display = "none";
      return;
    }

    showAutocomplete(inputDesa, listDesa, daftarDesa);
  });

  document.addEventListener("click", function (e) {
    if (!listKota.contains(e.target) && e.target !== inputKota) listKota.style.display = "none";
    if (!listKecamatan.contains(e.target) && e.target !== inputKecamatan) listKecamatan.style.display = "none";
    if (!listDesa.contains(e.target) && e.target !== inputDesa) listDesa.style.display = "none";
  });


  // Kirim ke Google Apps Script / Spreadsheet
  form.addEventListener("submit", async function (e) {
    e.preventDefault();

    // Validasi dasar file
    const fileInput = document.getElementById("foto");
    if (!fileInput.files.length) {
        statusBox.className = "status-box status-error";
        statusBox.textContent = "Harap unggah foto KTP.";
        statusBox.style.display = "block";
        return;
    }

    // Mengambil semua data formulir, termasuk file, menggunakan FormData
    const formData = new FormData(form); 
    
    statusBox.style.display = "block";
    statusBox.className = "status-box";
    statusBox.textContent = "Mengirim data dan mengunggah foto ke Google Drive...";
    btnKirim.disabled = true;

    try {
      // Menggunakan fetch dengan FormData
      const response = await fetch(scriptUrl, {
        method: "POST",
        body: formData // Kirim FormData langsung
      });

      const resultText = await response.text();
      let result;
      try {
        result = JSON.parse(resultText);
      } catch (e) {
        result = { result: 'error', message: 'Respon tidak valid dari Apps Script.' };
      }

      if (response.ok && result.result === 'success') {
        const message = "Pendaftaran berhasil dikirim dan dicatat di Google Spreadsheet.\n\n" +
                        "Ringkasan Data (detail file ada di Spreadsheet):\n" +
                        `NIK: ${formData.get('nik')}\n` +
                        `Nama: ${formData.get('nama')}\n` +
                        `Paket: ${formData.get('paket')}\n`;
                        
        statusBox.className = "status-box status-success";
        statusBox.textContent = message;
        form.reset();
      } else {
        statusBox.className = "status-box status-error";
        statusBox.textContent =
          "Gagal mencatat data.\n\n" + (result.message || "Periksa log Apps Script Anda dan pastikan otorisasi Drive sudah diberikan.");
      }
    } catch (err) {
      statusBox.className = "status-box status-error";
      statusBox.textContent =
        "Terjadi kesalahan jaringan saat mengirim data:\n" + err;
    } finally {
      btnKirim.disabled = false;
    }
  });
</script>

</body>
</html>
